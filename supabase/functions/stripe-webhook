import Stripe from 'stripe';
import { serve } from 'std/server';
import { createClient } from '@supabase/supabase-js';

const supabaseUrl = Deno.env.get('SUPABASE_URL');
const supabaseKey = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY');
const supabase = createClient(supabaseUrl, supabaseKey);

const stripe = new Stripe(Deno.env.get('STRIPE_SECRET_KEY'), { apiVersion: '2022-11-15' });
const endpointSecret = Deno.env.get('STRIPE_WEBHOOK_SECRET');

serve(async (req) => {
  const body = await req.text();
  const sig = req.headers.get('stripe-signature');

  let event;

  try {
    event = stripe.webhooks.constructEvent(body, sig, endpointSecret);
  } catch (err) {
    console.error('⚠️  Webhook signature verification failed.', err.message);
    return new Response(`Webhook Error: ${err.message}`, { status: 400 });
  }

  // Handle the event
  switch (event.type) {
    case "checkout.session.completed":
      const session = event.data.object as Stripe.Checkout.Session;
      const user_id = session.metadata?.user_id;
      const plan = session.metadata?.plan;

      if (!user_id || !plan) {
        console.warn("Missing user_id or plan in session metadata");
        break;
      }

      // Calculate subscription validity
      let valid_from = new Date();
      let valid_until = new Date(valid_from);

      if (plan === "monthly") valid_until.setMonth(valid_until.getMonth() + 1);
      else if (plan === "yearly") valid_until.setFullYear(valid_until.getFullYear() + 1);

      try {
        // Insert subscription into Supabase table
        const { error } = await supabase.from("user_subscriptions").insert([
          {
            user_id,
            plan_id: plan,
            valid_from: valid_from.toISOString(),
            valid_until: valid_until.toISOString(),
          },
        ]);
        if (error) console.error("Failed to insert subscription:", error.message);
      } catch (err) {
        console.error("Error inserting subscription:", err.message);
      }
      break;


    case 'customer.subscription.deleted':
      const deletedSub = event.data.object;
      await supabase
        .from('user_subscriptions')
        .update({ status: 'canceled', updated_at: new Date() })
        .eq('stripe_subscription_id', deletedSub.id);
      break;

    default:
      console.log(`Unhandled event type ${event.type}`);
  }

  return new Response(JSON.stringify({ received: true }), { status: 200 });
});
